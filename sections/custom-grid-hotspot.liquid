{% comment %}
  Section: product-hotspot-grid.liquid
  Features:
  - Grid of 6 blocks (3 per row desktop, 2 per row mobile)
  - Each block: image picker + product selector
  - Circular marker positioned via top/left percentages
  - Clicking marker opens modal with product details, variant selector, and Add to Cart
  - No external libraries; accessible dialog; responsive
{% endcomment %}

<section id="product-hotspot-grid-{{ section.id }}" class="phg-section page-width">
  <div class="phg-grid">
    {% for block in section.blocks %}
      {% assign product = block.settings.product %}
      <div class="phg-card" {{ block.shopify_attributes }}>
        <div class="phg-media">
          {% if block.settings.image != blank %}
            {% render 'image', image: block.settings.image, widths: '360,540,720,960', sizes: '(max-width: 768px) 50vw, 33vw', alt: block.settings.image.alt | escape %}
          {% else %}
            {{ 'product-' | append: forloop.index | placeholder_svg_tag }}
          {% endif %}
          {{ product.title }}
          {% if product %}
            {%- assign top = block.settings.top_percent | default: 50 -%}
            {%- assign left = block.settings.left_percent | default: 50 -%}
            <button
              class="phg-marker"
              type="button"
              style="top: {{ top }}%; left: {{ left }}%;"
              aria-haspopup="dialog"
              aria-controls="phg-modal-{{ section.id }}-{{ forloop.index }}"
              data-phg-open="#phg-modal-{{ section.id }}-{{ forloop.index }}"
              title="{{ block.settings.marker_label | default: product.title | escape }}"
            >
              {% if block.settings.marker_label != blank %}
                <span class="phg-marker__label">{{ block.settings.marker_label }}</span>
              {% endif %}
            </button>
          {% endif %}
        </div>

        {% if product %}
          <!-- Modal for this block -->
          <div
            id="phg-modal-{{ section.id }}-{{ forloop.index }}"
            class="phg-modal"
            role="dialog"
            aria-modal="true"
            aria-labelledby="phg-modal-title-{{ section.id }}-{{ forloop.index }}"
            aria-hidden="true"
          >
            <div class="phg-modal__backdrop" data-phg-close></div>
            <div class="phg-modal__dialog" role="document">
              <button class="phg-modal__close" type="button" aria-label="Close" data-phg-close>&times;</button>

              <div class="phg-modal__content">
                <div class="phg-modal__gallery">
                  {% if product.media.size > 0 %}
                    {% for media in product.media limit: 6 %}
                      {% case media.media_type %}
                        {% when 'image' %}
                          <img
                            loading="lazy"
                            src="{{ media | image_url: width: 720 }}"
                            alt="{{ media.alt | default: product.title | escape }}"
                            class="phg-modal__img"
                          >
                        {% when 'external_video', 'video' %}
                          {{ media | media_tag: image_size: '720x' }}
                        {% else %}
                          {# skip other media types #}
                      {% endcase %}
                    {% endfor %}
                  {% else %}
                    <img
                      loading="lazy"
                      src="{{ product.featured_image | image_url: width: 720 }}"
                      alt="{{ product.title | escape }}"
                      class="phg-modal__img"
                    >
                  {% endif %}
                </div>

                <div class="phg-modal__details" data-product-id="{{ product.id }}">
                  <h3 id="phg-modal-title-{{ section.id }}-{{ forloop.index }}" class="phg-modal__title">
                    {{ product.title }}
                  </h3>
                  <div class="phg-price" data-phg-price>
                    {% assign first_available = product.variants
                      | where: 'available', true
                      | first
                      | default: product.variants.first
                    %}
                    <span class="phg-price__amount" data-phg-price-amount>
                      {{ first_available.price | money }}
                    </span>
                    {% if first_available.compare_at_price > first_available.price %}
                      <s class="phg-price__compare" data-phg-price-compare>
                        {{- first_available.compare_at_price | money -}}
                      </s>
                    {% endif %}
                  </div>

                  {% if product.variants.size > 1 %}
                    <label for="phg-variant-{{ section.id }}-{{ forloop.index }}" class="phg-label"
                      >Choose variant</label
                    >
                    <select
                      id="phg-variant-{{ section.id }}-{{ forloop.index }}"
                      class="phg-select"
                      data-phg-variant-select
                    >
                      {% for v in product.variants %}
                        <option
                          value="{{ v.id }}"
                          data-price="{{ v.price }}"
                          data-compare="{{ v.compare_at_price }}"
                          {% if v == first_available %}
                            selected
                          {% endif %}
                          {% unless v.available %}
                            disabled
                          {% endunless %}
                        >
                          {{ v.title }} - {{ v.price | money }}
                          {% unless v.available %}(Sold out){% endunless %}
                        </option>
                      {% endfor %}
                    </select>
                  {% else %}
                    <input type="hidden" value="{{ product.variants.first.id }}" data-phg-single-variant>
                  {% endif %}

                  <button type="button" class="phg-atc" data-phg-atc>Add to cart</button>
                  <div class="phg-atc__status" aria-live="polite"></div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <style>
    #product-hotspot-grid-{{ section.id }} { --phg-gap: {{ section.settings.grid_gap | default: 16 }}px; }
    #product-hotspot-grid-{{ section.id }} .phg-grid {
      display: grid;
      gap: var(--phg-gap);
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    @media (max-width: 768px) {
      #product-hotspot-grid-{{ section.id }} .phg-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    #product-hotspot-grid-{{ section.id }} .phg-card { position: relative; background: var(--color-background, #fff); border-radius: 14px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    #product-hotspot-grid-{{ section.id }} .phg-media { position: relative; aspect-ratio: 4/5; background: #f6f6f6; }
    #product-hotspot-grid-{{ section.id }} .phg-media img, #product-hotspot-grid-{{ section.id }} .phg-media svg { width:100%; height:100%; object-fit: cover; display:block; }

    /* Marker */
    #product-hotspot-grid-{{ section.id }} .phg-marker {
      position: absolute; transform: translate(-50%, -50%);
      width: 38px; height: 38px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; background: rgba(0,0,0,.6); color: #fff; display:flex; align-items:center; justify-content:center; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    #product-hotspot-grid-{{ section.id }} .phg-marker:focus { outline: 2px solid #000; outline-offset: 2px; }
    #product-hotspot-grid-{{ section.id }} .phg-marker__label { padding: 0 6px; white-space: nowrap; }

    /* Modal */
    #product-hotspot-grid-{{ section.id }} .phg-modal { position: fixed; inset: 0; display: none; z-index: 9; }
    #product-hotspot-grid-{{ section.id }} .phg-modal[aria-hidden="false"] { display:block; }
    #product-hotspot-grid-{{ section.id }} .phg-modal__backdrop { position:absolute; inset:0; background: rgba(0,0,0,.4); }
    #product-hotspot-grid-{{ section.id }} .phg-modal__dialog { position: relative; margin: 5vh auto; max-width: 960px; background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    #product-hotspot-grid-{{ section.id }} .phg-modal__close { position:absolute; top:10px; right:12px; background: transparent; border: 0; font-size: 28px; cursor: pointer; line-height: 1; }

    #product-hotspot-grid-{{ section.id }} .phg-modal__content { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; padding: 18px; }
    @media (max-width: 768px){ #product-hotspot-grid-{{ section.id }} .phg-modal__content { grid-template-columns: 1fr; } }

    #product-hotspot-grid-{{ section.id }} .phg-modal__gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    #product-hotspot-grid-{{ section.id }} .phg-modal__img { width: 100%; height: auto; border-radius: 10px; display:block; }

    #product-hotspot-grid-{{ section.id }} .phg-modal__title { margin: 0 0 6px; font-size: 1.25rem; }
    #product-hotspot-grid-{{ section.id }} .phg-price { margin: 8px 0 16px; font-size: 1.125rem; display:flex; gap:10px; align-items: baseline; }
    #product-hotspot-grid-{{ section.id }} .phg-price__compare { color: #888; font-size: .95rem; }
    #product-hotspot-grid-{{ section.id }} .phg-label { display:block; margin-bottom: 6px; font-weight: 600; }
    #product-hotspot-grid-{{ section.id }} .phg-select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    #product-hotspot-grid-{{ section.id }} .phg-atc { margin-top: 12px; width: 100%; padding: 12px 14px; border-radius: 12px; border: 0; background: #111; color: #fff; cursor: pointer; font-weight: 600; }
    #product-hotspot-grid-{{ section.id }} .phg-atc__status { margin-top: 8px; min-height: 1.2em; font-size: .95rem; }
  </style>

  <script>
    (function () {
      const root = document.getElementById('product-hotspot-grid-{{ section.id }}');
      if (!root) return;

      /** Open/close modal helpers */
      const openModal = (modal) => {
        if (!modal) return;
        modal.setAttribute('aria-hidden', 'false');
        // focus management
        const closeBtn = modal.querySelector('[data-phg-close]');
        closeBtn && closeBtn.focus();
        document.documentElement.style.overflow = 'hidden';
      };
      const closeModal = (modal) => {
        if (!modal) return;
        modal.setAttribute('aria-hidden', 'true');
        document.documentElement.style.overflow = '';
      };

      root.addEventListener('click', function (e) {
        const opener = e.target.closest('[data-phg-open]');
        if (opener) {
          const sel = opener.getAttribute('data-phg-open');
          const modal = document.querySelector(sel);
          openModal(modal);
        }

        const closer = e.target.closest('[data-phg-close]');
        if (closer) {
          const modal = closer.closest('.phg-modal');
          closeModal(modal);
        }
      });

      document.addEventListener('click', function (e) {
        if (e.target.matches('.phg-modal__backdrop')) {
          closeModal(e.target.closest('.phg-modal'));
        }
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.phg-modal[aria-hidden="false"]').forEach((m) => closeModal(m));
        }
      });

      /** Variant change -> update price */
      root.querySelectorAll('[data-phg-variant-select]').forEach(function (select) {
        select.addEventListener('change', function () {
          const modal = select.closest('.phg-modal');
          const priceWrap = modal.querySelector('[data-phg-price]');
          const amount = modal.querySelector('[data-phg-price-amount]');
          const compare = modal.querySelector('[data-phg-price-compare]');
          const opt = select.selectedOptions[0];
          const price = Number(opt.dataset.price || 0);
          const compareVal = Number(opt.dataset.compare || 0);

          // Money formatting using shop's locale via Intl if available
          try {
            const fmt = new Intl.NumberFormat('{{ shop.locale }}', {
              style: 'currency',
              currency: '{{ shop.currency }}',
            });
            amount.textContent = fmt.format(price / 100);
            if (compare) {
              if (compareVal > price) {
                compare.textContent = fmt.format(compareVal / 100);
                compare.style.display = '';
              } else {
                compare.style.display = 'none';
              }
            }
          } catch (err) {
            amount.textContent = (price / 100).toFixed(2);
            if (compare) {
              compare.textContent = (compareVal / 100).toFixed(2);
            }
          }
        });
      });

      /** Add to cart */
      root.querySelectorAll('[data-phg-atc]').forEach(function (btn) {
        btn.addEventListener('click', async function () {
          const container = btn.closest('.phg-modal__details');
          const status = container.querySelector('.phg-atc__status');
          const cart = document.querySelector('.cart-drawer') || document.querySelector('.cart-popup');
          let variantId = null;
          const select = container.querySelector('[data-phg-variant-select]');
          const single = container.querySelector('[data-phg-single-variant]');
          if (select) {
            variantId = select.value;
          } else if (single) {
            variantId = single.value;
          }
          if (!variantId) {
            status.textContent = 'Please select a variant.';
            return;
          }
          btn.disabled = true;
          status.textContent = 'Addingâ€¦';
          
          try {
            let formData = {
                items: [{
                id: parseInt(variantId),
                quantity: 1
                }]
            }
            formData["sections"] = "cart-drawer";
            const res = await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData),
            });
            if (!res.ok) throw new Error('Add to cart failed');
            status.textContent = 'Added to cart!';
            btn.disabled = false;
            let cartData = await res.json();
            // Update cart drawer if it exists
            const cartDrawer = cartData.sections;
            let cartContainer = cartDrawer["cart-drawer"];
            // console.log(cartContainer);
            let temDiv = document.createElement('div');
            temDiv.innerHTML = cartContainer;
            let mainCart = temDiv.querySelector('#shopify-section-cart-drawer');
            let oldCart = document.querySelector('cart-drawer');
            console.log("newCart", mainCart);
            console.log("oldCart", oldCart);
            // if (oldCart) {
            //   oldCart.replaceWith(mainCart);
            // } else {
            //   document.body.appendChild(mainCart);
            // }
            // mainCart.setAttribute('aria-hidden', 'false');
            // mainCart.querySelector()
            // console.log(cartDrawer);
          } catch (err) {
            console.error('Add to cart error:', err);
            status.textContent = 'Sorry, something went wrong.';
            btn.disabled = false;
          }
        });
      });
    })();
  </script>
</section>

{% schema %}
{
  "name": "Product Hotspot Grid",
  "tag": "section",
  "class": "section-product-hotspot-grid",
  "settings": [
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid gap (px)",
      "min": 0,
      "max": 40,
      "step": 2,
      "default": 16
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "Grid Block",
      "limit": 6,
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Block image" },
        { "type": "product", "id": "product", "label": "Select product" },
        { "type": "text", "id": "marker_label", "label": "Marker label (optional)", "default": "+" },
        {
          "type": "range",
          "id": "top_percent",
          "label": "Marker top (%)",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50
        },
        {
          "type": "range",
          "id": "left_percent",
          "label": "Marker left (%)",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Product Hotspot Grid",
      "category": "Custom",
      "blocks": [
        { "type": "hotspot" },
        { "type": "hotspot" },
        { "type": "hotspot" },
        { "type": "hotspot" },
        { "type": "hotspot" },
        { "type": "hotspot" }
      ]
    }
  ]
}
{% endschema %}

{% stylesheet %}
  /* Optionally keep empty; styles inlined above for scoping */
{% endstylesheet %}

{% javascript %}
  /* Optionally keep empty; JS inlined above for scoping */
{% endjavascript %}
